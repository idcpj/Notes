[TOC]



## 数据表关联,可以查询范围连用
### 一对多关联
```
class BookModel extends RelationModel{
    protected $_link=[
        'book_episodes'=>[                      //关联表名
            'mapping_type'=>self::HAS_MANY,
            'foreign_key'=>'bid',
            'mapping_fields'=>'ji_no,title',
            'mapping_limit'=>'20',
            'mapping_order'=>'ji_no asc'
            //'parent_key'=>'id',  主表id,
            //'condition'=>'',  复杂查询条件
        ]
}
```
## 模型的scope 场景设置
```
namespace Home\Model;
use Think\Model;
class NewsModel extends Model {
     protected $_scope = array(
         // 命名范围normal
         'normal'=>array(
             'where'=>array('status'=>1),
         ),
         // 命名范围latest
         'latest'=>array(
             'order'=>'create_time DESC',
             'limit'=>10,
         ),
     );
}

//调用
D("News")->scope('normal')->select();
```



## 用视图模型进行多表查询 ViewModel
关联表
```
在模块下的Model目录
class ChannelViewModel extends ViewModel{
    protected $viewFields=array(
        'Channel'=>array('id','channel_name','token','_type'=>'RIGHT'), //right对应下表的
        'Member'=>array('name','idcard','_on'=>'Channel.id=Member.channel_id')

    );
}

在控制器中调用
D("ChannelView")->where(array('id' => 47))->select() 以普通视图一样
```


## 数据库操作

### 添加操作
```php


if(!$channel->create($data)){
    $this->error($channel->getError());
}else{
    $channel->add();
}
```

###  更新操作
1. 方法一,不使用create 方法
```php

$channelData =D("Channel")->where(array('id'=>1));
//判断是否有值
if(!$channelData->find()){
	$this->error(暂无数据);
}
$channel->status=1;  //没有报错后继续赋值
$channel->save()
```
2. 方法二
```
$channel = D("Channel");
//直接在参数中写入主键,则视为更新
$data=array(
    'id'=>1,
    'create_time'=>111,
    'update_time'=>1112,
    'token'=>'',
);

if(!$channel->create($data)){
    $this->error($channel->getError());
}else{
    $channel->save();
}

```
###  查询操作
```php
//符合条件的一个值
D("test")->where(['age'=>11])->getField('id');  //return  String 2

//查询符合条件的多个值,第二个参数加true
D("test")->where(['age'=>11])->getField('id',true);  //return  array ( 0 => '2', 1 => '3')

//通过条件查询整条数据
$data=M('Test')->getByName('白俊遥');

//通过条件查询字段
M('read_adv_media')->getFieldById($id,'aid');  //return string 12


```

### 自动验证
model 模型中
```
protected $_validate  = array (
	array('phone','require','手机号必填',1)
    array('name','2,6','申请人姓名不能为空',self::MUST_VALIDATE,'length'),
    array('phone','/^0?(13|14|15|17|18|19)[0-9]{9}$/','手机格式不正确',self::MUST_VALIDATE,'regex'),
    array('marital',array('未婚','已婚','离婚'),'婚姻内容不正确',self::VALUE_VALIDATE,'in'),
    array('other_userid','1,50','渠道方订单格式错误',self::VALUE_VALIDATE,'length'),
	array('other_userid','','渠道方订单重复',self::VALUE_VALIDATE,'unique'),  //同一个字段可多次验证
);

//验证后的操作
protected $_auto=array(
    array('create_time','time',self::MODEL_INSERT,'function'),
    array('update_time','time',self::MODEL_BOTH,'function'),
    array('our_orderid','sp_get_order_sn',self::MODEL_INSERT,'function'),
);
```
控制器中
```
$member = D("Member");
//注意有 ! 号
if (!$member->create($this->postData)){ //  如果为$_POST提交则不选在create中传入数据
    $this->error(303,$member->getError());
}
$member->add();
    
```

## mysql的查询缓存 cache

```
//加key值可提高效率 也可通过 S('channel') 调用`
M("channel")->cache('channel',10)->select();
```
可通过在config.php 设置 `DATA_CACHE_TIME` 值来设置默认值.设置方法见[配置设置](#_2) ,原默认值为0,即永久缓存
```
return array(
	    'DATA_CACHE_TIME'=>60  //缓存时间为60秒
	);
```
