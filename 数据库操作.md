[TOC]



## 数据表关联,可以查询范围连用
### 一对多关联
```
class BookModel extends RelationModel{
    protected $_link=[
        'book_episodes'=>[                      //关联表名
            'mapping_type'=>self::HAS_MANY,
            'foreign_key'=>'bid',
            'mapping_fields'=>'ji_no,title',
            'mapping_limit'=>'20',
            'mapping_order'=>'ji_no asc'
            //'parent_key'=>'id',  主表id,
            //'condition'=>'',  复杂查询条件
        ]
}
```
## 模型的scope 场景设置
```
namespace Home\Model;
use Think\Model;
class NewsModel extends Model {
     protected $_scope = array(
         'normal'=>array(
             'where'=>array('status'=>1),
         ),
         'latest'=>array(
             'order'=>'create_time DESC',
             'limit'=>10,
         ),
         // 默认的命名范围
         'default'=>array(
             'where'=>array('status'=>1),
             'limit'=>10,
         ),
     );
}

//调用
D("News")->scope('normal')->select();

//混合使用
$Model->scope('normal')->limit(8)->order('id desc')->select();

//支持属性
//where , field , order , limit , page , having , group , lock , distinct , cache\
//支持连贯调用
$Model->scope('normal')->scope('latest')->select(); 
$Model->scope('normal,latest')->select();  //简便操作,若冲突,则前面覆盖后面

//默认调用
$Model->scope()->select();
```



## 用视图模型进行多表查询 ViewModel
关联表
```
在模块下的Model目录
class ChannelViewModel extends ViewModel{
    protected $viewFields=array(
        'Channel'=>array('id','channel_name','token','_type'=>'RIGHT'), //right对应下表的
        'Member'=>array('name','idcard','_on'=>'Channel.id=Member.channel_id')

    );
}

在控制器中调用
D("ChannelView")->where(array('id' => 47))->select() 以普通视图一样
```


## 数据库操作

### 添加操作
```php


if(!$channel->create($data)){
    $this->error($channel->getError());
}else{
	$channel->create_time =time();
    $channel->add();
}
```

###  更新操作
1. 方法一,不使用create 方法
```php

$channelData =D("Channel")->where(array('id'=>1));
//判断是否有值
if(!$channelData->find()){
	$this->error(暂无数据);
}
$channel->status=1;  //没有报错后继续赋值
$channel->save()
```
2. 方法二
```
$channel = D("Channel");
//直接在参数中写入主键,则视为更新
$data=array(
    'id'=>1,
    'create_time'=>111,
    'update_time'=>1112,
    'token'=>'',
);

if(!$channel->create($data)){
    $this->error($channel->getError());
}else{
    $channel->save();
}

```
###  查询操作
```php
//符合条件的一个值
D("test")->where(['age'=>11])->getField('id');  //return  String 2

//查询符合条件的多个值,第二个参数加true
D("test")->where(['age'=>11])->getField('id',true);  //return  array ( 0 => '2', 1 => '3')

//通过条件查询整条数据
$data=M('Test')->getByName('白俊遥');

//通过条件查询字段
M('read_adv_media')->getFieldById($id,'aid');  //return string 12


```

### 自动验证
model 模型中
```
protected $_validate = array(
     ['phone','require','手机号必填',self::EXISTS_VALIDATE,],  //self::EXISTS_VALIDATE =0   表单存在字段则验证
     ['phone',PHONE_REGEX,'手机号格式错误',self::EXISTS_VALIDATE,'regex'],
     ['phone','','手机号已被注册',self::EXISTS_VALIDATE,'unique'],
     ['password','require','密码必填',self::EXISTS_VALIDATE],
     ['password','3,13','长度过短',self::EXISTS_VALIDATE,'length'],
     ['password_2','password','密码不一致',self::EXISTS_VALIDATE,'confirm'], //confirm 表示password_2字段与password字段 是否相等
     ['check','123','与check1不相等',self::EXISTS_VALIDATE,'equal'],  //equal 表示check字段是否等于 123
     ['tel','usecall','tel不通过',self::EXISTS_VALIDATE,'callback','0575'],  //第六个参数 就是回调函数的第一个参数可以是数组
 );

 //只能进行布尔判断,不能重新赋值
 protected function usecall($pre){
    $user = D("user")->where(['user'=>'demo'])->find();
    if($user){
        return true;
    }else{
        return false;
    }
 }
 
//验证后的操作
protected $_auto  = [
     ['ip','2',self::MODEL_UPDATE], //更新时为1
     ['ip','1',self::MODEL_INSERT],  //添加时为2
     ['password', 'md5_pwd', self::MODEL_BOTH, 'callback']
 ];

 //默认参数就是字段的参数
 public function md5_pwd($pas){
    return md5($pas."abc");
 }
```
控制器中
```
$member = D("Member");
//注意有 ! 号
if (!$member->create($this->postData)){ //  如果为$_POST提交则不选在create中传入数据
    $this->error(303,$member->getError());
}
$member->add();
    
```

## mysql的查询缓存 cache

```
//加key值可提高效率 也可通过 S('channel') 调用`
M("channel")->cache('channel',10)->select();
```
可通过在config.php 设置 `DATA_CACHE_TIME` 值来设置默认值.设置方法见[配置设置](#_2) ,原默认值为0,即永久缓存
```
return array(
	    'DATA_CACHE_TIME'=>60  //缓存时间为60秒
	);
```
